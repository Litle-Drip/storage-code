<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
  <title>The Juice | Premium P2P Escrow</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.10.0/dist/index.umd.js"></script>

  <style>
    :root {
      --bg: #05060b;
      --surface: #111218;
      --surface-light: #1c1d26;
      --accent: #00eaff;
      --accent-dim: rgba(0, 234, 255, 0.1);
      --text: #f4f4f5;
      --muted: #94a3b8;
      --border: #27272f;
      --radius: 20px;
      --success: #10b981;
      --error: #ef4444;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0;
      background: var(--bg);
      background-image: radial-gradient(circle at top right, #1a202c 0%, #05060b 40%);
      color: var(--text);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      line-height: 1.5;
      min-height: 100vh;
    }

    /* Header & Navigation */
    .nav-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      backdrop-filter: blur(12px);
      background: rgba(5, 6, 11, 0.7);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo { font-weight: 800; font-size: 1.25rem; letter-spacing: -0.5px; color: var(--accent); }
    
    .wallet-status {
      font-size: 0.75rem;
      padding: 6px 14px;
      border-radius: 99px;
      background: var(--surface-light);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }
    .wallet-status.ok { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }

    .container { max-width: 480px; margin: 2rem auto; padding: 0 1rem; }

    /* VIP Card Styling */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      margin-bottom: 1.5rem;
    }

    .tabs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      background: #000;
      padding: 4px;
      border-radius: 12px;
      margin-bottom: 1.5rem;
    }
    .tab-btn {
      padding: 10px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-weight: 600;
      cursor: pointer;
      border-radius: 10px;
      font-size: 0.85rem;
      transition: 0.2s;
    }
    .tab-btn.active { background: var(--surface-light); color: var(--accent); }

    /* Form Elements */
    .input-group { margin-bottom: 1.25rem; }
    label { display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); margin-bottom: 0.5rem; }
    
    input, select {
      width: 100%;
      background: #000;
      border: 1px solid var(--border);
      padding: 14px;
      border-radius: 12px;
      color: white;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    input:focus { border-color: var(--accent); outline: none; }

    .stake-box {
        display: flex;
        gap: 10px;
        align-items: center;
        background: #000;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 5px 12px;
    }
    .stake-box input { border: none; padding: 10px 0; width: 100%; font-size: 1.5rem; font-weight: 700; }
    .stake-box span { font-size: 1.25rem; color: var(--muted); }

    .btn-main {
      width: 100%;
      padding: 16px;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.1s, background 0.2s;
    }
    .btn-main:active { transform: scale(0.98); }
    .btn-main:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      margin-top: 10px;
    }

    /* Live Summary Dashboard */
    .summary-box {
      background: var(--accent-dim);
      border: 1px solid var(--accent);
      border-radius: 12px;
      padding: 1rem;
      margin-top: 1rem;
    }
    .summary-row { display: flex; justify-content: space-between; margin: 4px 0; font-size: 0.85rem; }
    .summary-label { color: var(--muted); }
    .summary-value { font-weight: 600; color: var(--accent); }

    /* Share Section */
    .share-area { text-align: center; border-top: 1px solid var(--border); pt: 1.5rem; mt: 1.5rem; }
    .qr-container { background: white; padding: 10px; border-radius: 12px; display: inline-block; margin: 1rem 0; }
    
    /* Footer */
    .footer { text-align: center; font-size: 0.75rem; color: var(--muted); padding: 2rem 0; }
    .footer a { color: var(--accent); text-decoration: none; margin: 0 10px; }

    /* Modals */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal-content {
      background: var(--surface);
      border: 1px solid var(--error);
      border-radius: var(--radius);
      padding: 2rem;
      max-width: 400px;
      width: 100%;
      text-align: center;
    }

    #panelJoin, #panelCreate { display: none; }
    #panelCreate.active, #panelJoin.active { display: block; }
  </style>
</head>
<body>

<div class="nav-bar">
  <div class="logo">THE JUICE</div>
  <div id="sbState" class="wallet-status" onclick="connect()">Connect Wallet</div>
</div>

<div class="container">
  
  <div class="card">
    <div class="tabs">
      <button id="tabCreate" class="tab-btn active">PROPOSE</button>
      <button id="tabJoin" class="tab-btn">RESOLVE</button>
    </div>

    <div id="panelCreate" class="active">
      <div class="input-group">
        <label>Challenge Narrative</label>
        <div style="position:relative">
          <input type="text" id="ideaBox" placeholder="What is the challenge?">
          <button id="btnShuffle" style="position:absolute; right:10px; top:12px; background:none; border:none; cursor:pointer; font-size:1.2rem;">ðŸŽ²</button>
        </div>
      </div>

      <div class="input-group">
        <label>Stake Amount</label>
        <div class="stake-box">
          <span id="stakeSymbol">$</span>
          <input type="number" id="stakeMain" value="5">
          <select id="currency" style="width: auto; border: none; background: none; font-weight: bold; font-size: 0.8rem; padding: 0;">
            <option value="USD">USD</option>
            <option value="ETH">ETH</option>
          </select>
        </div>
        <p id="usdNote" style="font-size: 0.7rem; color: var(--muted); margin-top: 5px;">Estimating ETH via Coinbase API...</p>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div class="input-group">
          <label>Join Window</label>
          <select id="joinMins">
            <option value="15">15 Minutes</option>
            <option value="60">1 Hour</option>
            <option value="1440">24 Hours</option>
          </select>
        </div>
        <div class="input-group">
          <label>Resolution</label>
          <select id="resolveMins">
            <option value="30">30 Minutes</option>
            <option value="120">2 Hours</option>
            <option value="2880">48 Hours</option>
          </select>
        </div>
      </div>

      <button id="btnCreate" class="btn-main">INITIALIZE ESCROW</button>
      <div id="createStatus" style="font-size: 0.75rem; text-align: center; margin-top: 10px;"></div>
    </div>

    <div id="panelJoin">
      <div class="input-group">
        <label>Enter Challenge ID</label>
        <input type="number" id="betId" placeholder="e.g. 104">
      </div>
      
      <div id="challengeSummary" style="display:none;" class="summary-box">
        <div class="summary-row"><span class="summary-label">Pot:</span> <span id="sbPot" class="summary-value">0.00 ETH</span></div>
        <div class="summary-row"><span class="summary-label">Winner Winnings:</span> <span id="sbWin" class="summary-value">0.00 ETH</span></div>
        <div class="summary-row"><span class="summary-label">Protocol Fee:</span> <span class="summary-value">2.5%</span></div>
      </div>

      <div style="display:grid; grid-template-columns: 1fr; gap: 10px; margin-top: 1rem;">
        <button id="btnJoin" class="btn-main">JOIN CHALLENGE</button>
        <div style="display:flex; gap:10px;">
          <button id="btnIWon" class="btn-main btn-ghost" style="flex:1">I WON</button>
          <button id="btnILost" class="btn-main btn-ghost" style="flex:1">THEY WON</button>
        </div>
        <button id="btnPayout" class="btn-main" style="background:var(--success); color:white;">FINALIZE PAYOUT</button>
        <button id="btnRefund" class="btn-main btn-ghost" style="color:var(--error); border-color:var(--error);">REQUEST REFUND</button>
      </div>
      <div id="actionStatus" style="font-size: 0.75rem; text-align: center; margin-top: 10px;"></div>
    </div>
  </div>

  <div id="shareSection" class="card" style="display:none;">
    <div class="share-area">
      <label>Challenge Ready to Share</label>
      <div class="qr-container" id="qrBox"></div>
      <input type="text" id="shareUrl" readonly style="font-size: 0.8rem; background: var(--surface-light); text-align: center;">
      <button id="btnCopyLink" class="btn-main btn-ghost" style="font-size: 0.8rem; padding: 8px;">COPY CHALLENGE URL</button>
    </div>
  </div>

</div>

<div class="footer">
  <div>Â© <span id="year"></span> The Juice Labs â€¢ Base Network</div>
  <div style="margin-top:10px;">
    <a href="#">Terms</a><a href="#">Security</a><a href="#">Basescan</a>
  </div>
</div>

<div id="errorModal" class="modal">
  <div class="modal-content">
    <h3 style="color:var(--error); margin-top:0;">System Notice</h3>
    <p id="errorMsg" style="font-size: 0.9rem; color:var(--muted);"></p>
    <button onclick="document.getElementById('errorModal').style.display='none'" class="btn-main" style="background:var(--surface-light); color:white;">Dismiss</button>
  </div>
</div>

<input type="hidden" id="stakeEth" value="0.001">

<script>
/* LOGIC INTEGRATION
   Preserving all your specific contract addresses and logic from new.html 
*/

const NETWORKS = {
  mainnet: { idHex: '0x2105', contract: '0x474b39dF73745CFC9D84A961b2544b4b236757Dc', rpc: 'https://mainnet.base.org', explorer: 'https://basescan.org' },
  testnet: { idHex: '0x14A34', contract: '0x61eD264AAEF359717B2070E0426B26aa27D54890', rpc: 'https://sepolia.base.org', explorer: 'https://sepolia.basescan.org' }
};

let CURRENT_NET = 'mainnet';
let ETH_PRICE = 3500;
let provider, signer;
const ABI = [
  'function openChallenge(uint256 stakeWei, uint16 feeBps, uint64 joinWindowSeconds, uint64 resolveWindowSeconds) payable returns (uint256 challengeId)',
  'function joinChallenge(uint256 challengeId) payable',
  'function submitOutcomeVote(uint256 challengeId, bool challengerWon)',
  'function resolveChallenge(uint256 challengeId)',
  'function issueRefund(uint256 challengeId)',
  'function getChallenge(uint256 challengeId) view returns (address challenger, address participant, uint256 stakeWei, uint16 feeBps, uint64 joinDeadline, uint64 resolveDeadline, uint64 createdAt, uint8 state, int8 challengerVote, int8 participantVote)',
  'function nextChallengeId() view returns (uint256)'
];

const $ = id => document.getElementById(id);

// --- Core Logic ---

async function refreshPrice() {
  try {
    const res = await fetch('https://api.coinbase.com/v2/prices/ETH-USD/spot');
    const data = await res.json();
    ETH_PRICE = parseFloat(data.data.amount);
    $('usdNote').textContent = `1 ETH â‰ˆ $${ETH_PRICE.toLocaleString()}`;
  } catch(e) {}
}

function updateStake() {
  const val = parseFloat($('stakeMain').value) || 0;
  if ($('currency').value === 'USD') {
    const ethVal = val / ETH_PRICE;
    $('stakeEth').value = ethVal.toFixed(6);
  } else {
    $('stakeEth').value = val.toFixed(6);
  }
}

async function connect() {
  if (!window.ethereum) return showError("No Web3 Wallet found.");
  try {
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    $('sbState').textContent = accounts[0].slice(0,6) + '...' + accounts[0].slice(-4);
    $('sbState').classList.add('ok');
  } catch(e) { showError("Connection failed."); }
}

async function doCreate() {
    if (!signer) await connect();
    const btn = $('btnCreate');
    btn.disabled = true;
    $('createStatus').textContent = "Broadcasting to Base...";
    
    try {
        const contract = new ethers.Contract(NETWORKS[CURRENT_NET].contract, ABI, signer);
        const stakeWei = ethers.parseEther($('stakeEth').value);
        const jm = parseInt($('joinMins').value) * 60;
        const rm = parseInt($('resolveMins').value) * 60;

        const tx = await contract.openChallenge(stakeWei, 250, jm, rm, { value: stakeWei });
        const receipt = await tx.wait();
        
        const nextId = await contract.nextChallengeId();
        const betId = (BigInt(nextId) - 1n).toString();
        
        $('betId').value = betId;
        showShareArea(betId);
        $('createStatus').textContent = "âœ… Challenge #" + betId + " Created!";
    } catch(e) { 
        showError(e.message || "Transaction failed");
        $('createStatus').textContent = "";
    } finally { btn.disabled = false; }
}

// --- UI Helpers ---

function showError(msg) {
    $('errorMsg').textContent = msg;
    $('errorModal').style.display = 'flex';
}

function showShareArea(id) {
    const url = window.location.origin + window.location.pathname + "?bet=" + id;
    $('shareUrl').value = url;
    $('qrBox').innerHTML = "";
    new QRCode($('qrBox'), { text: url, width: 140, height: 140 });
    $('shareSection').style.display = 'block';
}

$('tabCreate').onclick = () => {
    $('panelCreate').classList.add('active');
    $('panelJoin').classList.remove('active');
    $('tabCreate').classList.add('active');
    $('tabJoin').classList.remove('active');
};

$('tabJoin').onclick = () => {
    $('panelJoin').classList.add('active');
    $('panelCreate').classList.remove('active');
    $('tabJoin').classList.add('active');
    $('tabCreate').classList.remove('active');
};

$('stakeMain').oninput = updateStake;
$('currency').onchange = () => {
    $('stakeSymbol').textContent = $('currency').value === 'USD' ? '$' : 'Îž';
    updateStake();
};

$('btnCreate').onclick = doCreate;

$('btnShuffle').onclick = () => {
    const ideas = ["Winner of 8-Ball Pool", "First to 5 Goals", "Golf: Low score on Hole 9", "Darts: Best of 3", "Coin Flip"];
    $('ideaBox').value = ideas[Math.floor(Math.random()*ideas.length)];
};

$('btnCopyLink').onclick = () => {
    navigator.clipboard.writeText($('shareUrl').value);
    $('btnCopyLink').textContent = "COPIED!";
    setTimeout(() => $('btnCopyLink').textContent = "COPY CHALLENGE URL", 2000);
};

// Initial Load
window.onload = () => {
    refreshPrice();
    $('year').textContent = new Date().getFullYear();
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('bet')) {
        $('betId').value = urlParams.get('bet');
        $('tabJoin').click();
    }
};

/* JOIN / RESOLVE Logic 
   Mapping existing functions to new UI 
*/
async function getContract() { return new ethers.Contract(NETWORKS[CURRENT_NET].contract, ABI, signer); }

$('btnJoin').onclick = async () => {
    if(!signer) await connect();
    try {
        const c = await getContract();
        const id = $('betId').value;
        const b = await c.getChallenge(id);
        const tx = await c.joinChallenge(id, { value: b[2] });
        await tx.wait();
        $('actionStatus').textContent = "âœ… Successfully Joined!";
    } catch(e) { showError(e.message); }
};

$('btnIWon').onclick = async () => {
    if(!signer) await connect();
    try {
        const c = await getContract();
        const id = $('betId').value;
        const tx = await c.submitOutcomeVote(id, true);
        await tx.wait();
        $('actionStatus').textContent = "âœ… Vote Recorded: You Won";
    } catch(e) { showError(e.message); }
};

$('btnILost').onclick = async () => {
    if(!signer) await connect();
    try {
        const c = await getContract();
        const id = $('betId').value;
        const tx = await c.submitOutcomeVote(id, false);
        await tx.wait();
        $('actionStatus').textContent = "âœ… Vote Recorded: Opponent Won";
    } catch(e) { showError(e.message); }
};

$('btnPayout').onclick = async () => {
    if(!signer) await connect();
    try {
        const c = await getContract();
        const tx = await c.resolveChallenge($('betId').value);
        await tx.wait();
        $('actionStatus').textContent = "âœ… Funds Disbursed!";
    } catch(e) { showError("Stalemate: Both parties must agree on winner."); }
};

$('btnRefund').onclick = async () => {
    if(!signer) await connect();
    try {
        const c = await getContract();
        const tx = await c.issueRefund($('betId').value);
        await tx.wait();
        $('actionStatus').textContent = "âœ… Refund Processed";
    } catch(e) { showError("Refund not available yet. Check deadlines."); }
};
</script>
</body>
</html>
